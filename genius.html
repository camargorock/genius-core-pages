<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GENIUS v3.6 â€” Workbook Definitivo</title>
<link rel="icon" type="image/svg+xml" href="./favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Sora:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06060e;
  --bg2: #0c0c1a;
  --glass: rgba(255,255,255,0.035);
  --glass2: rgba(255,255,255,0.055);
  --glass3: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --v1: #7c3aed; --v2: #a855f7; --v3: #c084fc;
  --c1: #06b6d4; --c2: #22d3ee; --c3: #67e8f9;
  --g1: #10b981; --g2: #34d399; --g3: #6ee7b7;
  --y1: #f59e0b; --y2: #fbbf24; --y3: #fcd34d;
  --r1: #ef4444; --r2: #f87171; --r3: #fca5a5;
  --p1: #ec4899; --p2: #f472b6;
  --text: #e8eaf0; --muted: #7c8194; --dim: #4a4e63;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Sora', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);line-height:1.7;overflow-x:hidden;min-height:100vh;}

/* â”€â”€ GLOBAL BACKGROUND â”€â”€ */
body::before{content:'';position:fixed;inset:0;
  background:
    radial-gradient(ellipse 100% 70% at 20% -10%, rgba(124,58,237,.15), transparent 60%),
    radial-gradient(ellipse 80% 60% at 80% 20%, rgba(6,182,212,.1), transparent 50%),
    radial-gradient(ellipse 60% 40% at 50% 90%, rgba(236,72,153,.08), transparent 50%);
  pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(124,58,237,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(124,58,237,.04) 1px, transparent 1px);
  background-size:60px 60px;pointer-events:none;z-index:0;opacity:.5;}

/* â”€â”€ HERO â”€â”€ */
.hero{position:relative;padding:60px 20px 40px;text-align:center;z-index:1;}
.hero-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.4;pointer-events:none;}
.hero-orb.a{width:400px;height:400px;background:var(--v1);top:-100px;left:-100px;}
.hero-orb.b{width:300px;height:300px;background:var(--c1);top:-50px;right:-80px;}
.hero-orb.c{width:250px;height:250px;background:var(--p1);bottom:-80px;left:50%;}
.hero-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 18px;border-radius:50px;
  background:linear-gradient(135deg,rgba(124,58,237,.25),rgba(168,85,247,.15));
  border:1px solid rgba(124,58,237,.4);font-size:.72rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--v3);margin-bottom:20px;}
.hero-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--g2);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(.7);}}
.hero h1{font-size:clamp(2.5rem,7vw,4.5rem);font-weight:800;letter-spacing:-.03em;line-height:1.05;
  background:linear-gradient(135deg,#fff 0%,var(--c3) 30%,var(--v3) 60%,var(--p2) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:14px;}
.hero-sub{font-size:1rem;color:var(--muted);max-width:650px;margin:0 auto 28px;font-weight:300;}
.hero-pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.hpill{padding:5px 14px;border-radius:50px;font-size:.73rem;font-weight:600;border:1px solid;
  backdrop-filter:blur(10px);}
.hpill.v{border-color:rgba(124,58,237,.4);color:var(--v3);background:rgba(124,58,237,.1);}
.hpill.c{border-color:rgba(6,182,212,.4);color:var(--c3);background:rgba(6,182,212,.1);}
.hpill.g{border-color:rgba(16,185,129,.4);color:var(--g3);background:rgba(16,185,129,.1);}
.hpill.y{border-color:rgba(245,158,11,.4);color:var(--y3);background:rgba(245,158,11,.1);}
.hpill.p{border-color:rgba(236,72,153,.4);color:var(--p2);background:rgba(236,72,153,.1);}
.hero-stats{display:flex;gap:32px;justify-content:center;margin-top:32px;flex-wrap:wrap;}
.hstat{text-align:center;}
.hstat .n{font-size:1.8rem;font-weight:800;
  background:linear-gradient(135deg,var(--c2),var(--v2));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;}
.hstat .l{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}

/* â”€â”€ TABS NAV â”€â”€ */
.tabs-wrap{position:sticky;top:0;z-index:100;padding:12px 0;
  background:rgba(6,6,14,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.tabs-scroll{max-width:1300px;margin:0 auto;overflow-x:auto;padding:0 16px;
  scrollbar-width:thin;scrollbar-color:var(--v1) transparent;}
.tabs-scroll::-webkit-scrollbar{height:3px;}
.tabs-scroll::-webkit-scrollbar-thumb{background:var(--v1);border-radius:3px;}
.tabs{display:flex;gap:4px;width:max-content;}
.tab{padding:8px 16px;border-radius:10px;font-size:.78rem;font-weight:600;cursor:pointer;
  color:var(--muted);border:1px solid transparent;transition:all .25s;white-space:nowrap;
  background:transparent;user-select:none;}
.tab:hover{color:var(--text);background:var(--glass);}
.tab.active{color:#fff;background:linear-gradient(135deg,rgba(124,58,237,.25),rgba(6,182,212,.15));
  border-color:rgba(124,58,237,.35);box-shadow:0 0 20px rgba(124,58,237,.15);}

/* â”€â”€ CONTENT â”€â”€ */
.container{max-width:1200px;margin:0 auto;padding:0 20px;position:relative;z-index:1;}
.panel{display:none;padding:48px 0 60px;animation:fadeIn .4s ease;}
.panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€ SECTION TITLE â”€â”€ */
.stitle{font-size:1.6rem;font-weight:800;margin-bottom:28px;display:flex;align-items:center;gap:14px;}
.stitle .icon{font-size:1.3rem;}
.stitle .line{flex:1;height:1px;background:linear-gradient(90deg,var(--v1),var(--c1),transparent);}
.stitle2{font-size:1.15rem;font-weight:700;margin:28px 0 14px;color:var(--c2);}

/* â”€â”€ GLASS CARD â”€â”€ */
.card{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:24px;
  backdrop-filter:blur(12px);transition:border-color .2s;}
.card:hover{border-color:var(--border2);}
.card-grid{display:grid;gap:16px;}
.cols-2{grid-template-columns:repeat(auto-fit,minmax(320px,1fr));}
.cols-3{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}
.cols-4{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}

/* â”€â”€ GRADIENT CARDS â”€â”€ */
.gc{border-radius:14px;padding:20px;position:relative;overflow:hidden;}
.gc::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.04),transparent);pointer-events:none;}
.gc.v{background:linear-gradient(135deg,rgba(124,58,237,.18),rgba(168,85,247,.06));border:1px solid rgba(124,58,237,.25);}
.gc.c{background:linear-gradient(135deg,rgba(6,182,212,.15),rgba(16,185,129,.05));border:1px solid rgba(6,182,212,.25);}
.gc.y{background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(239,68,68,.05));border:1px solid rgba(245,158,11,.25);}
.gc.g{background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(6,182,212,.05));border:1px solid rgba(16,185,129,.25);}
.gc.r{background:linear-gradient(135deg,rgba(239,68,68,.15),rgba(168,85,247,.05));border:1px solid rgba(239,68,68,.25);}
.gc.p{background:linear-gradient(135deg,rgba(236,72,153,.15),rgba(124,58,237,.05));border:1px solid rgba(236,72,153,.25);}
.gc h3{font-size:.92rem;font-weight:700;margin-bottom:6px;}
.gc .val{font-size:1.5rem;font-weight:800;}
.gc .sub{font-size:.8rem;color:var(--muted);margin-top:4px;}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto;border-radius:12px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th{background:rgba(124,58,237,.12);padding:11px 14px;text-align:left;font-size:.72rem;
  text-transform:uppercase;letter-spacing:1px;color:var(--v3);border-bottom:1px solid var(--border);font-weight:700;}
td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}

/* â”€â”€ CODE â”€â”€ */
.cb{background:rgba(0,0,0,.45);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin:12px 0;}
.ch{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;
  background:rgba(255,255,255,.025);border-bottom:1px solid var(--border);}
.cl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.cl.js{color:var(--y2);}.cl.sql{color:var(--c2);}.cl.json{color:var(--g2);}
.cl.txt{color:var(--p2);}
.dots{display:flex;gap:5px;}
.dots i{width:10px;height:10px;border-radius:50%;display:block;}
.dots .r{background:#ff5f57;}.dots .y{background:#febc2e;}.dots .g{background:#28c840;}
pre{padding:18px;overflow-x:auto;font-size:.8rem;line-height:1.6;font-family:var(--mono);color:#d4d4d8;}
.kw{color:var(--v3);}.str{color:var(--g3);}.cmt{color:var(--dim);font-style:italic;}
.fn{color:var(--c3);}.num{color:var(--y3);}.op{color:var(--p2);}

/* â”€â”€ STATE CARDS â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
.sc{border-radius:14px;padding:18px;border:1px solid;transition:transform .2s,box-shadow .2s;}
.sc:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.3);}
.sc.cliente{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.25);}
.sc.buffer{background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.25);}
.sc.eqin{background:rgba(124,58,237,.06);border-color:rgba(124,58,237,.25);}
.sc.eqout{background:rgba(6,182,212,.06);border-color:rgba(6,182,212,.25);}
.sn{font-size:.95rem;font-weight:800;margin-bottom:10px;}
.sc.cliente .sn{color:var(--g3);}.sc.buffer .sn{color:var(--y3);}
.sc.eqin .sn{color:var(--v3);}.sc.eqout .sn{color:var(--c3);}
.sr{display:flex;justify-content:space-between;font-size:.78rem;padding:3px 0;
  border-bottom:1px solid rgba(255,255,255,.04);}
.sr:last-child{border-bottom:none;}
.sk{color:var(--muted);}.sv{font-weight:600;font-family:var(--mono);font-size:.75rem;}

/* â”€â”€ FLOW TIMELINE â”€â”€ */
.flow{display:flex;flex-direction:column;}
.fi{display:flex;gap:14px;}
.fl{display:flex;flex-direction:column;align-items:center;}
.fd{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:.75rem;flex-shrink:0;border:2px solid;}
.fc{width:2px;flex:1;min-height:20px;}
.ft{flex:1;padding:6px 0 18px;}
.ft h4{font-size:.88rem;font-weight:700;margin-bottom:3px;}
.ft p{font-size:.78rem;color:var(--muted);}

/* â”€â”€ ROUTE ROWS â”€â”€ */
.rr{display:grid;grid-template-columns:130px 1fr 1fr;gap:14px;align-items:start;
  padding:14px 18px;border-radius:12px;background:var(--glass);border:1px solid var(--border);
  margin-bottom:8px;transition:background .2s;}
.rr:hover{background:var(--glass2);}
.rb{display:inline-block;padding:4px 10px;border-radius:20px;font-size:.72rem;font-weight:700;text-align:center;}
.rb.ein{background:rgba(124,58,237,.15);color:var(--v3);border:1px solid rgba(124,58,237,.3);}
.rb.eout{background:rgba(6,182,212,.15);color:var(--c3);border:1px solid rgba(6,182,212,.3);}
.rb.buf{background:rgba(245,158,11,.15);color:var(--y3);border:1px solid rgba(245,158,11,.3);}
.rb.cli{background:rgba(16,185,129,.15);color:var(--g3);border:1px solid rgba(16,185,129,.3);}
.rb.cad{background:rgba(236,72,153,.15);color:var(--p2);border:1px solid rgba(236,72,153,.3);}
.rb.abn{background:rgba(239,68,68,.15);color:var(--r3);border:1px solid rgba(239,68,68,.3);}
.rl{font-size:.72rem;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}
.rv{font-size:.82rem;}

/* â”€â”€ INVARIANT ROWS â”€â”€ */
.ir{display:flex;gap:14px;align-items:flex-start;padding:14px 18px;border-radius:12px;
  background:var(--glass);border-left:3px solid;margin-bottom:8px;}
.ir.ok{border-color:var(--g2);}.ir.warn{border-color:var(--y2);}.ir.err{border-color:var(--r2);}
.ir .ii{font-size:1.1rem;flex-shrink:0;margin-top:2px;}
.ir .it{font-weight:700;font-size:.88rem;margin-bottom:2px;}
.ir .id{font-size:.8rem;color:var(--muted);}

/* â”€â”€ TAGS â”€â”€ */
.tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.7rem;font-weight:600;
  font-family:var(--mono);background:rgba(124,58,237,.12);color:var(--v3);border:1px solid rgba(124,58,237,.2);}
.tag.c{background:rgba(6,182,212,.12);color:var(--c3);border-color:rgba(6,182,212,.2);}
.tag.g{background:rgba(16,185,129,.12);color:var(--g3);border-color:rgba(16,185,129,.2);}
.tag.y{background:rgba(245,158,11,.12);color:var(--y3);border-color:rgba(245,158,11,.2);}
.tag.r{background:rgba(239,68,68,.12);color:var(--r3);border-color:rgba(239,68,68,.2);}

/* â”€â”€ PERF BARS â”€â”€ */
.pb{margin-bottom:10px;}
.pl{display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:5px;}
.pt{height:6px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden;}
.pf{height:100%;border-radius:3px;}

/* â”€â”€ ALERT â”€â”€ */
.alert{padding:14px 20px;border-radius:12px;font-size:.88rem;display:flex;align-items:center;gap:10px;}
.alert.r{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--r3);}
.alert.g{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--g3);}
.alert.y{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--y3);}

/* â”€â”€ PIPELINE ASCII â”€â”€ */
.pipeline-box{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:14px;
  padding:24px;overflow-x:auto;font-family:var(--mono);font-size:.72rem;line-height:1.5;
  color:var(--c3);white-space:pre;}

/* â”€â”€ DIVIDER â”€â”€ */
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--v1),var(--c1),var(--p1),transparent);
  margin:8px 0 0;}

/* â”€â”€ FOOTER â”€â”€ */
.footer{text-align:center;padding:48px 20px;color:var(--muted);font-size:.82rem;
  border-top:1px solid var(--border);position:relative;z-index:1;}
.footer strong{background:linear-gradient(135deg,var(--v2),var(--c2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:linear-gradient(var(--v1),var(--c1));border-radius:3px;}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px){
  .cols-2,.cols-3,.cols-4{grid-template-columns:1fr;}
  .rr{grid-template-columns:1fr;gap:8px;}
  .hero h1{font-size:2rem;}
  .hero-stats{gap:20px;}
}

/* â”€â”€ SEARCH â”€â”€ */
.search-wrap{max-width:500px;margin:0 auto 0;position:relative;}
.search-wrap input{width:100%;padding:10px 18px 10px 40px;border-radius:50px;border:1px solid var(--border);
  background:var(--glass);color:var(--text);font-family:var(--sans);font-size:.85rem;outline:none;
  transition:border-color .2s;}
.search-wrap input:focus{border-color:var(--v1);}
.search-wrap .si{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.9rem;}
</style>
</head>
<body>

<!-- â•â•â• HERO â•â•â• -->
<div class="hero">
  <div class="hero-orb a"></div><div class="hero-orb b"></div><div class="hero-orb c"></div>
  <div class="hero-badge"><span class="dot"></span> Production Grade Â· v3.6 Â· 63 NÃ³s</div>
  <h1>GENIUS AI System</h1>
  <p class="hero-sub">Workbook Definitivo â€” Single Source of Truth<br>Atendimento Persuasivo por IA Â· Arquitetura Orientada a Estado</p>
  <div class="hero-pills">
    <span class="hpill v">n8n Orchestration</span>
    <span class="hpill c">SQL State Machine</span>
    <span class="hpill g">Evolution API</span>
    <span class="hpill y">LLM Agent</span>
    <span class="hpill p">Redis Buffer</span>
  </div>
  <div class="hero-stats">
    <div class="hstat"><div class="n">63</div><div class="l">NÃ³s ProduÃ§Ã£o</div></div>
    <div class="hstat"><div class="n">7</div><div class="l">Rotas</div></div>
    <div class="hstat"><div class="n">4</div><div class="l">Estados</div></div>
    <div class="hstat"><div class="n">22</div><div class="l">SeÃ§Ãµes</div></div>
    <div class="hstat"><div class="n">6</div><div class="l">Invariantes</div></div>
  </div>
</div>
<div class="divider"></div>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs-wrap">
  <div class="tabs-scroll">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="filosofia">ðŸ›ï¸ Filosofia</div>
      <div class="tab" data-tab="infra">ðŸ—ï¸ Infra</div>
      <div class="tab" data-tab="banco">ðŸ—„ï¸ Banco</div>
      <div class="tab" data-tab="estados">ðŸš¦ Estados</div>
      <div class="tab" data-tab="pipeline">ðŸ”„ Pipeline</div>
      <div class="tab" data-tab="adapters">ðŸ”Œ Adapters</div>
      <div class="tab" data-tab="code">ðŸ’» Code Nodes</div>
      <div class="tab" data-tab="sql">ðŸ—ƒï¸ SQL Nodes</div>
      <div class="tab" data-tab="rotas">ðŸ—ºï¸ Rotas</div>
      <div class="tab" data-tab="checkfail">ðŸ”¥ Check Fail</div>
      <div class="tab" data-tab="followup">ðŸ“¡ Follow-Up</div>
      <div class="tab" data-tab="cron">â° Cron</div>
      <div class="tab" data-tab="redis">âš¡ Redis</div>
      <div class="tab" data-tab="output">ðŸ“¤ Output</div>
      <div class="tab" data-tab="guardrails">ðŸ›¡ï¸ Guardrails</div>
      <div class="tab" data-tab="workbook">ðŸ“ Workbook</div>
      <div class="tab" data-tab="troubleshoot">ðŸ”§ Troubleshoot</div>
      <div class="tab" data-tab="antireg">ðŸ“‹ Anti-RegressÃ£o</div>
    </div>
  </div>
</div>

<div class="container">

<!-- â•â•â• TAB: FILOSOFIA â•â•â• -->
<div class="panel active" id="filosofia">
  <div class="stitle"><span class="icon">ðŸ›ï¸</span> Filosofia & Invariantes <span class="line"></span></div>
  
  <div class="card-grid cols-3" style="margin-bottom:20px">
    <div class="gc v"><h3>ðŸ§­ OrquestraÃ§Ã£o</h3><div class="val" style="background:linear-gradient(135deg,var(--v3),var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">n8n orquestra</div><div class="sub">Todo fluxo passa pelo n8n â€” sem exceÃ§Ã£o</div></div>
    <div class="gc c"><h3>ðŸ—„ï¸ Estado</h3><div class="val" style="background:linear-gradient(135deg,var(--c3),var(--g3));-webkit-background-clip:text;-webkit-text-fill-color:transparent">SQL governa</div><div class="sub">Somente SQL lÃª e escreve estado</div></div>
    <div class="gc y"><h3>ðŸ¤– InteligÃªncia</h3><div class="val" style="background:linear-gradient(135deg,var(--y3),var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">LLM gera texto</div><div class="sub">IA nunca decide rota, nunca escreve BD</div></div>
  </div>

  <div class="alert r" style="margin-bottom:24px">âš ï¸ <strong>ViolaÃ§Ã£o de qualquer regra = Bug.</strong> O documento Ã© soberano. Sistema e IA se adaptam a ele â€” nunca o contrÃ¡rio.</div>

  <div class="stitle2">ðŸ”’ 6 Invariantes Absolutas</div>
  <div class="ir ok"><span class="ii">1ï¸âƒ£</span><div><div class="it">n8n orquestra tudo</div><div class="id">Todo fluxo passa pelo n8n â€” sem bypasses, sem atalhos</div></div></div>
  <div class="ir ok"><span class="ii">2ï¸âƒ£</span><div><div class="it">SQL governa estado</div><div class="id">O banco Ã© a Ãºnica fonte de verdade de estado</div></div></div>
  <div class="ir ok"><span class="ii">3ï¸âƒ£</span><div><div class="it">IA nÃ£o decide rotas</div><div class="id">LLM sÃ³ gera texto â€” nunca escolhe rota</div></div></div>
  <div class="ir ok"><span class="ii">4ï¸âƒ£</span><div><div class="it">IA nÃ£o escreve no banco</div><div class="id">Nunca. Zero exceÃ§Ãµes. Nem em "modo emergÃªncia"</div></div></div>
  <div class="ir ok"><span class="ii">5ï¸âƒ£</span><div><div class="it">Adapters sÃ£o imutÃ¡veis</div><div class="id">Schema fixo, sem lÃ³gica, sem migraÃ§Ã£o informal</div></div></div>
  <div class="ir ok"><span class="ii">6ï¸âƒ£</span><div><div class="it">JSON downstream nunca quebra</div><div class="id">Adapter garante tipos antes de qualquer downstream</div></div></div>

  <div class="stitle2">ðŸŽ¯ Identidade do Sistema</div>
  <div class="card" style="margin-bottom:16px">
    <p style="font-size:.92rem;margin-bottom:12px">O GENIUS <strong>nÃ£o Ã© um chatbot</strong>. Ã‰ uma <strong style="color:var(--c2)">mÃ¡quina de estado</strong> que usa IA como ferramenta de geraÃ§Ã£o de texto.</p>
    <div class="card-grid cols-2" style="gap:10px">
      <div class="gc g" style="padding:14px"><div class="sub">LLM Ã© fraca, opinativa e descartÃ¡vel</div></div>
      <div class="gc g" style="padding:14px"><div class="sub">LÃ³gica crÃ­tica Ã© 100% determinÃ­stica</div></div>
      <div class="gc g" style="padding:14px"><div class="sub">Estado explÃ­cito â€” nunca implÃ­cito</div></div>
      <div class="gc g" style="padding:14px"><div class="sub">Falha previsÃ­vel > sucesso frÃ¡gil</div></div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: INFRA â•â•â• -->
<div class="panel" id="infra">
  <div class="stitle"><span class="icon">ðŸ—ï¸</span> Infraestrutura <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="card">
      <div style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--v2);font-weight:700;margin-bottom:14px">Endpoints</div>
      <div class="tw"><table>
        <tr><th>Componente</th><th>Valor</th></tr>
        <tr><td>n8n</td><td><code style="color:var(--c3);font-size:.78rem">n8n-n8n.l6josh.easypanel.host</code></td></tr>
        <tr><td>Evolution API</td><td><code style="color:var(--c3);font-size:.78rem">n8n-evolution-api.l6josh.easypanel.host</code></td></tr>
        <tr><td>Supabase</td><td><code style="color:var(--c3);font-size:.78rem">dupcanuaaawhhispqtjg</code></td></tr>
        <tr><td>InstÃ¢ncia WA</td><td><span class="tag g">gi</span></td></tr>
        <tr><td>Workflow ID</td><td><span class="tag">kk6RqCFdOLZBTzZa</span></td></tr>
      </table></div>
    </div>
    <div class="card">
      <div style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--c2);font-weight:700;margin-bottom:14px">Constantes do Sistema</div>
      <div class="card-grid cols-2" style="gap:10px">
        <div class="gc c" style="padding:14px"><div class="sub">Abandono Timeout</div><div class="val" style="font-size:1.3rem">2min</div><div class="sub" style="font-size:.68rem">120000ms</div></div>
        <div class="gc v" style="padding:14px"><div class="sub">Follow-up Cooldown</div><div class="val" style="font-size:1.3rem">3h</div><div class="sub" style="font-size:.68rem">10800000ms</div></div>
        <div class="gc y" style="padding:14px"><div class="sub">Follow-up Max</div><div class="val" style="font-size:1.3rem">2</div><div class="sub" style="font-size:.68rem">CHECK constraint</div></div>
        <div class="gc g" style="padding:14px"><div class="sub">Buffer Max</div><div class="val" style="font-size:1.3rem">2</div><div class="sub" style="font-size:.68rem">msgs_pendentes</div></div>
        <div class="gc p" style="padding:14px"><div class="sub">Redis Wait</div><div class="val" style="font-size:1.3rem">6s</div><div class="sub" style="font-size:.68rem">Dedup window</div></div>
        <div class="gc r" style="padding:14px"><div class="sub">Wait Msg Follow</div><div class="val" style="font-size:1.3rem">5min</div><div class="sub" style="font-size:.68rem">300000ms</div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: BANCO â•â•â• -->
<div class="panel" id="banco">
  <div class="stitle"><span class="icon">ðŸ—„ï¸</span> Banco de Dados <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="card">
      <div style="color:var(--v3);font-weight:700;margin-bottom:12px;font-size:.9rem">ðŸ“‹ dados_cliente â€” Estado do Lead</div>
      <div class="tw"><table>
        <tr><th>Campo</th><th>Tipo</th><th>Default</th></tr>
        <tr><td><code>"clientID"</code></td><td><span class="tag">VARCHAR(50) UNIQUE</span></td><td>â€”</td></tr>
        <tr><td><code>telefone</code></td><td><span class="tag">VARCHAR(50)</span></td><td>â€”</td></tr>
        <tr><td><code>nome</code></td><td><span class="tag">VARCHAR(100)</span></td><td>Cliente</td></tr>
        <tr><td><code>ia_ativa</code></td><td><span class="tag c">BOOLEAN</span></td><td><span style="color:var(--g3)">true</span></td></tr>
        <tr><td><code>wait</code></td><td><span class="tag y">BIGINT</span></td><td>0</td></tr>
        <tr><td><code>msgs_pendentes</code></td><td><span class="tag y">INT â‰¥0</span></td><td>0</td></tr>
        <tr><td><code>followup_count</code></td><td><span class="tag y">INT â‰¤2</span></td><td>0</td></tr>
        <tr><td><code>ultimo_followup</code></td><td><span class="tag y">BIGINT</span></td><td>0</td></tr>
        <tr><td><code>off</code></td><td><span class="tag c">BOOLEAN</span></td><td><span style="color:var(--r3)">false</span></td></tr>
        <tr><td><code>status</code></td><td><span class="tag">ENUM</span></td><td>new</td></tr>
      </table></div>
      <div class="alert y" style="margin-top:12px;font-size:.8rem">âš ï¸ <code>"clientID"</code> requer aspas duplas no PostgreSQL</div>
    </div>
    <div>
      <div class="card" style="margin-bottom:16px">
        <div style="color:var(--c3);font-weight:700;margin-bottom:12px;font-size:.9rem">ðŸ’¬ n8n_chat_histories</div>
        <div class="tw"><table>
          <tr><th>Campo</th><th>Tipo</th></tr>
          <tr><td><code>session_id</code></td><td><span class="tag">VARCHAR</span> = clientID</td></tr>
          <tr><td><code>message</code></td><td><span class="tag c">JSONB</span></td></tr>
          <tr><td><code>created_at</code></td><td><span class="tag">TIMESTAMPTZ</span></td></tr>
        </table></div>
        <div class="cb" style="margin-top:12px"><div class="ch"><span class="cl json">message JSONB</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>{
  "<span class="str">type</span>": "<span class="str">human</span>",
  "<span class="str">content</span>": "<span class="str">texto da mensagem</span>",
  "<span class="str">additional_kwargs</span>": "<span class="str">Equipe</span>" | "<span class="str">Cliente</span>",
  "<span class="str">response_metadata</span>": { "<span class="str">rota</span>": "<span class="str">EQUIPE_IN</span>", "<span class="str">timestamp</span>": <span class="num">1739654321000</span> }
}</pre></div>
      </div>
      <div class="card">
        <div style="color:var(--g3);font-weight:700;margin-bottom:12px;font-size:.9rem">ðŸ”’ Constraints CrÃ­ticas</div>
        <div class="cb"><div class="ch"><span class="cl sql">Constraint + Trigger</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">ALTER TABLE</span> dados_cliente
  <span class="kw">ADD CONSTRAINT</span> followup_max_2
  <span class="kw">CHECK</span> (followup_count >= <span class="num">0</span> <span class="kw">AND</span> followup_count <= <span class="num">2</span>);

<span class="kw">CREATE OR REPLACE FUNCTION</span> <span class="fn">auto_reset_followup</span>()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">BEGIN</span>
  <span class="kw">IF</span> NEW.followup_count > <span class="num">2</span> <span class="kw">THEN</span>
    NEW.followup_count := <span class="num">2</span>;
  <span class="kw">END IF</span>;
  <span class="kw">RETURN</span> NEW;
<span class="kw">END</span>; $$ <span class="kw">LANGUAGE</span> plpgsql;</pre></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: ESTADOS â•â•â• -->
<div class="panel" id="estados">
  <div class="stitle"><span class="icon">ðŸš¦</span> MÃ¡quina de Estados <span class="line"></span></div>
  
  <div class="sg" style="margin-bottom:28px">
    <div class="sc cliente"><div class="sn">âœ… CLIENTE</div><div class="sr"><span class="sk">ia_ativa</span><span class="sv" style="color:var(--g3)">true</span></div><div class="sr"><span class="sk">wait</span><span class="sv">0</span></div><div class="sr"><span class="sk">msgs</span><span class="sv">0</span></div><div class="sr"><span class="sk">destino</span><span class="sv">â†’ LLM</span></div></div>
    <div class="sc buffer"><div class="sn">â³ BUFFER</div><div class="sr"><span class="sk">ia_ativa</span><span class="sv" style="color:var(--r3)">false</span></div><div class="sr"><span class="sk">wait</span><span class="sv">&gt;0</span></div><div class="sr"><span class="sk">msgs</span><span class="sv">1â€“2</span></div><div class="sr"><span class="sk">destino</span><span class="sv">â†’ SilÃªncio</span></div></div>
    <div class="sc eqin"><div class="sn">ðŸŸ£ EQUIPE IN</div><div class="sr"><span class="sk">ia_ativa</span><span class="sv" style="color:var(--r3)">false</span></div><div class="sr"><span class="sk">wait</span><span class="sv">timestamp</span></div><div class="sr"><span class="sk">msgs</span><span class="sv">0</span></div><div class="sr"><span class="sk">destino</span><span class="sv">â†’ PARA</span></div></div>
    <div class="sc eqout"><div class="sn">ðŸ”µ EQUIPE OUT</div><div class="sr"><span class="sk">ia_ativa</span><span class="sv" style="color:var(--g3)">true</span></div><div class="sr"><span class="sk">wait</span><span class="sv">0</span></div><div class="sr"><span class="sk">msgs</span><span class="sv">0</span></div><div class="sr"><span class="sk">destino</span><span class="sv">â†’ LLM</span></div></div>
  </div>

  <div class="stitle2">ðŸ”€ TransiÃ§Ãµes DeterminÃ­sticas</div>
  <div class="cb"><div class="ch"><span class="cl txt">State Transitions</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="fn">fromMe=false</span> + <span class="str">ia_ativa=true</span>                              â†’ <span class="kw">CLIENTE</span>
<span class="fn">fromMe=false</span> + <span class="str">ia_ativa=false</span> + <span class="num">msgs &lt; 2</span>                 â†’ <span class="kw">BUFFER</span> (msgs++)
<span class="fn">fromMe=false</span> + <span class="str">ia_ativa=false</span> + <span class="num">msgs â‰¥ 2</span>                 â†’ <span class="kw">CLIENTE</span> (IA retoma)
<span class="fn">fromMe=true</span>  + <span class="str">!fim</span>                                       â†’ <span class="kw">EQUIPE_IN</span> (ia=false)
<span class="fn">fromMe=true</span>  + <span class="str">fim</span> ([FIM]/tchau/obrigad/valeu)             â†’ <span class="kw">EQUIPE_OUT</span> (ia=true)

<span class="cmt">// ðŸ”¥ ABANDONO (Patch v7.2 â€” prioridade mÃ¡xima)</span>
<span class="fn">!ia_ativa</span> + <span class="num">msgs â‰¥ 1</span> + <span class="num">wait &gt; 0</span> + <span class="num">delta &gt; 120000ms</span>      â†’ <span class="kw">CLIENTE</span> (auto-resume)</pre></div>

  <div class="stitle2">ðŸ“ Regras de Estado</div>
  <div class="ir ok"><span class="ii">ðŸ”‡</span><div><div class="it">BUFFER nunca responde imediatamente</div><div class="id">SilÃªncio total â€” acumula msgs atÃ© limite</div></div></div>
  <div class="ir ok"><span class="ii">ðŸš«</span><div><div class="it">EQUIPE_IN bloqueia IA absolutamente</div><div class="id">Nenhuma resposta automÃ¡tica enquanto false</div></div></div>
  <div class="ir ok"><span class="ii">â™»ï¸</span><div><div class="it">EQUIPE_OUT reativa e zera contadores</div><div class="id">ia_ativa=true, wait=0, msgs=0</div></div></div>
  <div class="ir warn"><span class="ii">ðŸ’€</span><div><div class="it">KILL â€” equipe respondeu &lt; 10min apÃ³s handoff</div><div class="id">Check Fail detecta e decide: silÃªncio vs retomar</div></div></div>
  <div class="ir ok"><span class="ii">ðŸ”„</span><div><div class="it">Estado invÃ¡lido nÃ£o existe</div><div class="id">Fallback sempre para CLIENTE com healing</div></div></div>
</div>

<!-- â•â•â• TAB: PIPELINE â•â•â• -->
<div class="panel" id="pipeline">
  <div class="stitle"><span class="icon">ðŸ”„</span> Pipeline CanÃ´nico (63 nÃ³s) <span class="line"></span></div>

  <div class="card-grid cols-2">
    <div>
      <div class="stitle2">ðŸ”Œ Main Flow</div>
      <div class="flow">
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(124,58,237,.15);border-color:var(--v1);color:var(--v3)">WH</div><div class="fc" style="background:linear-gradient(var(--v1),var(--v2))"></div></div><div class="ft"><h4>Webhook</h4><p>POST /genius â€” Evolution API webhook</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(124,58,237,.15);border-color:var(--v2);color:var(--v3)">VF</div><div class="fc" style="background:linear-gradient(var(--v2),var(--c1))"></div></div><div class="ft"><h4>Verify â€” SQL</h4><p>LEFT JOIN + COALESCE Â· Nunca retorna zero linhas</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(6,182,212,.15);border-color:var(--c1);color:var(--c3)">CR</div><div class="fc" style="background:linear-gradient(var(--c1),var(--c2))"></div></div><div class="ft"><h4>Core v3.6</h4><p>Parseia webhook + merge DB Â· Boolean healing</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(6,182,212,.15);border-color:var(--c2);color:var(--c3)">C2</div><div class="fc" style="background:linear-gradient(var(--c2),var(--g1))"></div></div><div class="ft"><h4>Core II â­ Adapter</h4><p>Normaliza + healing leve Â· Zero lÃ³gica negÃ³cio</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(16,185,129,.15);border-color:var(--g1);color:var(--g3)">RT</div><div class="fc" style="background:linear-gradient(var(--g1),var(--g2))"></div></div><div class="ft"><h4>Router v7.2</h4><p>FunÃ§Ã£o pura determinÃ­stica Â· Patch abandono Â· 5 rotas</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(16,185,129,.15);border-color:var(--g2);color:var(--g3)">R2</div><div class="fc" style="background:linear-gradient(var(--g2),var(--y1))"></div></div><div class="ft"><h4>Router II â­ Adapter</h4><p>Contrato imutÃ¡vel Â· chatInput + modo + healing</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(245,158,11,.15);border-color:var(--y1);color:var(--y3)">SW</div><div class="fc" style="background:linear-gradient(var(--y1),var(--y2))"></div></div><div class="ft"><h4>Rotas (Switch)</h4><p>EQUIPE_IN | EQUIPE_OUT | CLIENTE | BUFFER</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(245,158,11,.15);border-color:var(--y2);color:var(--y3)">BF</div><div class="fc" style="background:linear-gradient(var(--y2),var(--p1))"></div></div><div class="ft"><h4>Briefing v10.5</h4><p>Injeta contexto mÃ­nimo p/ LLM Â· 12 situations</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(236,72,153,.15);border-color:var(--p1);color:var(--p2)">AI</div><div class="fc" style="background:linear-gradient(var(--p1),var(--p2))"></div></div><div class="ft"><h4>Agente LLM</h4><p>Memory + Tools + Deep/OpenAI Â· sessionId</p></div></div>
        <div class="fi"><div class="fl"><div class="fd" style="background:rgba(236,72,153,.15);border-color:var(--p2);color:var(--p2)">SL</div><div style="width:2px;height:0"></div></div><div class="ft"><h4>Selector v3.3 â†’ Spliter â†’ Envio</h4><p>Valida + divide parÃ¡grafos + Evolution API send</p></div></div>
      </div>
    </div>
    <div>
      <div class="stitle2">âš¡ Performance por NÃ³</div>
      <div class="card" style="padding:20px">
        <div class="pb"><div class="pl"><span>Webhook</span><span style="color:var(--g3)">instant</span></div><div class="pt"><div class="pf" style="width:1%;background:linear-gradient(90deg,var(--g2),var(--c2))"></div></div></div>
        <div class="pb"><div class="pl"><span>Verify (SQL)</span><span>~3ms</span></div><div class="pt"><div class="pf" style="width:3%;background:linear-gradient(90deg,var(--v2),var(--p2))"></div></div></div>
        <div class="pb"><div class="pl"><span>Core + Core II</span><span>~24ms</span></div><div class="pt"><div class="pf" style="width:10%;background:linear-gradient(90deg,var(--c2),var(--g2))"></div></div></div>
        <div class="pb"><div class="pl"><span>Router + Router II</span><span>~13ms</span></div><div class="pt"><div class="pf" style="width:7%;background:linear-gradient(90deg,var(--y2),var(--p2))"></div></div></div>
        <div class="pb"><div class="pl"><span>Briefing</span><span>~12ms</span></div><div class="pt"><div class="pf" style="width:6%;background:linear-gradient(90deg,var(--p2),var(--v2))"></div></div></div>
        <div class="pb"><div class="pl"><span>AI Agent (LLM)</span><span style="color:var(--y3)">2â€“5s</span></div><div class="pt"><div class="pf" style="width:80%;background:linear-gradient(90deg,var(--y2),var(--r2))"></div></div></div>
        <div class="pb"><div class="pl"><span>Selector + Spliter</span><span>~16ms</span></div><div class="pt"><div class="pf" style="width:8%;background:linear-gradient(90deg,var(--g2),var(--c2))"></div></div></div>
        <div class="pb" style="margin-bottom:0"><div class="pl"><span>Envio HTTP</span><span>1â€“2s</span></div><div class="pt"><div class="pf" style="width:40%;background:linear-gradient(90deg,var(--c2),var(--v2))"></div></div></div>
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);display:flex;gap:20px;font-size:.78rem">
          <span>Sem AI: <strong style="color:var(--g3)">~100ms</strong></span>
          <span>Com AI: <strong style="color:var(--y3)">~3â€“6s</strong></span>
        </div>
      </div>

      <div class="stitle2">ðŸ” Follow-up AssÃ­ncrono</div>
      <div class="card" style="padding:16px;font-family:var(--mono);font-size:.78rem;color:var(--c3)">
        Wait 5min â†’ Set Push â†’ Push Follow (SQL)<br>â†’ Follow Route (IF) â†’ Mark (SQL)<br>â†’ To Briefing â†’ LLM â†’ Envio
      </div>

      <div class="stitle2">ðŸš¦ ConvergÃªncia Final</div>
      <div class="alert g" style="font-size:.82rem">Todas as rotas convergem para 2 destinos reais: <strong>PARA</strong> (silÃªncio) ou <strong>AGENT</strong> (LLM)</div>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: ADAPTERS â•â•â• -->
<div class="panel" id="adapters">
  <div class="stitle"><span class="icon">ðŸ”Œ</span> Adapter Pattern <span class="line"></span></div>
  <div class="cb"><div class="ch"><span class="cl txt">PadrÃ£o ImutÃ¡vel</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>NÃ³ LÃ³gico (pode mudar)   â†’   <span class="kw">Adapter (NUNCA muda)</span>   â†’   Downstream (JSON garantido)</pre></div>
  <div class="tw" style="margin-top:16px"><table>
    <tr><th>Adapter</th><th>PosiÃ§Ã£o</th><th>FunÃ§Ã£o</th></tr>
    <tr><td><span class="tag">Core II</span></td><td>Core â†’ Core II</td><td>Normaliza entrada webhook</td></tr>
    <tr><td><span class="tag c">Router II</span></td><td>Router â†’ Router II</td><td>Contrato de decisÃ£o de rota</td></tr>
    <tr><td><span class="tag y">AI Output</span></td><td>(dentro Selector)</td><td>Valida saÃ­da LLM</td></tr>
    <tr><td><span class="tag g">SQL CTE</span></td><td>(CTE adapter nos SQLs)</td><td>Garante parÃ¢metros SQL</td></tr>
  </table></div>
  <div class="stitle2">âŒ O que Adapter NUNCA faz</div>
  <div class="ir err"><span class="ii">â›”</span><div><div class="it">ContÃ©m lÃ³gica de negÃ³cio</div><div class="id">Zero if/else decisÃ³rio â€” apenas normalizaÃ§Ã£o</div></div></div>
  <div class="ir err"><span class="ii">â›”</span><div><div class="it">Consulta outros nÃ³s</div><div class="id"><code>$('OutroNode')</code> Ã© proibido em adapters</div></div></div>
  <div class="ir err"><span class="ii">â›”</span><div><div class="it">Muda sem migraÃ§Ã£o formal</div><div class="id">ImutÃ¡vel â€” qualquer mudanÃ§a requer documentaÃ§Ã£o</div></div></div>
</div>

<!-- â•â•â• TAB: CODE â•â•â• -->
<div class="panel" id="code">
  <div class="stitle"><span class="icon">ðŸ’»</span> Code Nodes â€” ProduÃ§Ã£o <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="cb"><div class="ch"><span class="cl js">Core v3.6 â€” Parser</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">var</span> webhook = $(<span class="str">'Webhook'</span>).item.json.body || {};
<span class="kw">var</span> data = webhook.data || {};
<span class="kw">var</span> key = data.key || {};
<span class="kw">var</span> msg = data.message || {};
<span class="kw">var</span> DB = $(<span class="str">'Verify'</span>).item.json || {};

<span class="kw">var</span> ClientID = key.remoteJid || <span class="str">''</span>;
<span class="kw">var</span> telefone = ClientID.<span class="fn">replace</span>(
  <span class="str">/@s\.whatsapp\.net$/</span>, <span class="str">''</span>);

<span class="kw">var</span> message = msg.conversation
  || msg.extendedTextMessage?.text
  || msg.imageMessage?.caption
  || msg.videoMessage?.caption
  || (msg.audioMessage ? <span class="str">'[audio]'</span> : <span class="str">''</span>);

<span class="kw">var</span> fromMe = key.fromMe === <span class="kw">true</span>;

<span class="kw">return</span> [{ json: {
  ClientID, telefone, message, fromMe,
  nome: <span class="fn">String</span>(data.pushName || DB.nome || <span class="str">'cliente'</span>),
  db: { ia_ativa: DB.ia_ativa, wait: DB.wait,
        status: DB.status, is_new: DB.is_new },
  msgs_pendentes: <span class="fn">parseInt</span>(DB.msgs_pendentes) || <span class="num">0</span>
}}];</pre></div>
    <div class="cb"><div class="ch"><span class="cl js">Core II â€” Adapter</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">const</span> input = $input.<span class="fn">first</span>()?.json ?? {};

<span class="kw">const</span> <span class="fn">num</span>  = (v,d=<span class="num">0</span>) => <span class="fn">isNaN</span>(<span class="fn">Number</span>(v)) ? d : <span class="fn">Number</span>(v);
<span class="kw">const</span> <span class="fn">bool</span> = (v,d=<span class="kw">false</span>) => v == <span class="kw">null</span> ? d : <span class="fn">Boolean</span>(v);
<span class="kw">const</span> <span class="fn">str</span>  = (v,d=<span class="str">''</span>) => v == <span class="kw">null</span> ? d : <span class="fn">String</span>(v).<span class="fn">trim</span>();

<span class="kw">const</span> dbIn = input.db || {};
<span class="kw">const</span> ia_ativa = <span class="fn">bool</span>(dbIn.ia_ativa);
<span class="kw">const</span> wait_raw = <span class="fn">num</span>(dbIn.wait);

<span class="cmt">// healing: IA ativa â†’ wait nÃ£o existe</span>
<span class="kw">const</span> wait = ia_ativa ? <span class="num">0</span> : wait_raw;

<span class="kw">return</span> [{ json: {
  ...input,
  db: { ...dbIn, ia_ativa, wait },
  msgs_pendentes: <span class="fn">num</span>(input.msgs_pendentes),
  _debug: { adapter: <span class="str">'core-ii'</span> }
}}];</pre></div>
    <div class="cb"><div class="ch"><span class="cl js">Router v7.2 â€” FunÃ§Ã£o Pura</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">const</span> MAX_MSGS = <span class="num">2</span>;
<span class="kw">const</span> ABANDONO_TIMEOUT = <span class="num">120000</span>; <span class="cmt">// 2 min</span>

<span class="kw">const</span> fim = <span class="str">/\[FIM\]/i</span>.<span class="fn">test</span>(mensagem) ||
  <span class="str">/tchau|obrigad|valeu|atÃ©/i</span>.<span class="fn">test</span>(mensagem);
<span class="kw">const</span> delta = Date.<span class="fn">now</span>() - dbWait;

<span class="kw">let</span> rota = <span class="str">'CLIENTE'</span>;

<span class="cmt">// ðŸ”¥ ABANDONO (prioridade mÃ¡xima)</span>
<span class="kw">if</span> (!dbIaAtiva && msgs >= <span class="num">1</span> && dbWait > <span class="num">0</span>
    && delta > ABANDONO_TIMEOUT) {
  rota = <span class="str">'CLIENTE'</span>; novaIaAtiva = <span class="kw">true</span>;
  novoWait = <span class="num">0</span>; novoMsgs = <span class="num">0</span>;
}
<span class="kw">else if</span> (fromMe && !fim) {
  rota = <span class="str">'EQUIPE_IN'</span>; novaIaAtiva = <span class="kw">false</span>;
}
<span class="kw">else if</span> (fromMe && fim) {
  rota = <span class="str">'EQUIPE_OUT'</span>; novaIaAtiva = <span class="kw">true</span>;
}
<span class="kw">else if</span> (!fromMe && !dbIaAtiva && msgs < MAX_MSGS) {
  rota = <span class="str">'BUFFER'</span>; novoMsgs = msgs + <span class="num">1</span>;
}
<span class="kw">else if</span> (!fromMe && !dbIaAtiva && msgs >= MAX_MSGS) {
  rota = <span class="str">'CLIENTE'</span>; novaIaAtiva = <span class="kw">true</span>;
}</pre></div>
    <div class="cb"><div class="ch"><span class="cl js">Selector v3.3 â€” ValidaÃ§Ã£o</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="cmt">// Parse robusto: string | object | nested</span>
<span class="kw">let</span> parsed = {};
<span class="kw">try</span> {
  <span class="kw">if</span> (<span class="kw">typeof</span> output === <span class="str">'string'</span>) {
    parsed = <span class="fn">JSON.parse</span>(output
      .<span class="fn">replace</span>(<span class="str">/```json\n?|```\n?/g</span>, <span class="str">''</span>)
      .<span class="fn">trim</span>());
  }
} <span class="kw">catch</span>(e) {
  parsed = { mensagem_cliente: output };
}

<span class="cmt">// ValidaÃ§Ãµes</span>
statusOk  = [<span class="str">'new'</span>,<span class="str">'warm'</span>,<span class="str">'hot'</span>,<span class="str">'win'</span>,<span class="str">'loss'</span>,<span class="str">'off'</span>]
  .<span class="fn">includes</span>(parsed.status);
mensagemOk = msg.length > <span class="num">0</span> && msg.length <= <span class="num">500</span>;
linhasOk   = msg.<span class="fn">split</span>(<span class="str">'\n'</span>).length <= <span class="num">4</span>;

<span class="cmt">// Healing: status invÃ¡lido + msg ok â†’ 'new'</span>
<span class="kw">if</span> (!statusOk && mensagemOk) status = <span class="str">'new'</span>;</pre></div>
  </div>
</div>

<!-- â•â•â• TAB: SQL â•â•â• -->
<div class="panel" id="sql">
  <div class="stitle"><span class="icon">ðŸ—ƒï¸</span> SQL Nodes â€” ProduÃ§Ã£o <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="cb"><div class="ch"><span class="cl sql">Verify â€” LEFT JOIN</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">SELECT</span>
  <span class="fn">COALESCE</span>(b.<span class="str">"clientID"</span>, <span class="str">'{{ remoteJid }}'</span>) <span class="kw">AS</span> <span class="str">"clientID"</span>,
  <span class="fn">COALESCE</span>(b.ia_ativa, <span class="kw">true</span>)  <span class="kw">AS</span> ia_ativa,
  <span class="fn">COALESCE</span>(b.wait, <span class="num">0</span>)         <span class="kw">AS</span> wait,
  <span class="fn">COALESCE</span>(b.msgs_pendentes, <span class="num">0</span>) <span class="kw">AS</span> msgs_pendentes,
  <span class="kw">CASE WHEN</span> b.<span class="str">"clientID"</span> <span class="kw">IS NOT NULL</span>
    <span class="kw">THEN false ELSE true END</span> <span class="kw">AS</span> is_new
<span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="num">1</span>) dummy
<span class="kw">LEFT JOIN</span> dados_cliente b
  <span class="kw">ON</span> b.<span class="str">"clientID"</span> = <span class="str">'{{ remoteJid }}'</span>
<span class="kw">LIMIT</span> <span class="num">1</span></pre></div>
    <div class="cb"><div class="ch"><span class="cl sql">Equipe IN</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">UPDATE</span> dados_cliente <span class="kw">SET</span>
  ia_ativa       = <span class="kw">false</span>,
  msgs_pendentes = <span class="num">0</span>,
  wait = (<span class="fn">EXTRACT</span>(<span class="fn">EPOCH</span> <span class="kw">FROM NOW</span>()) * <span class="num">1000</span>)::<span class="kw">bigint</span>,
  updated_at     = <span class="fn">NOW</span>()
<span class="kw">WHERE</span> <span class="str">"clientID"</span> = <span class="str">'{{ ClientID }}'</span>
<span class="kw">RETURNING</span> wait;</pre></div>
    <div class="cb"><div class="ch"><span class="cl sql">Check Fail</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">SELECT</span>
  <span class="fn">COUNT</span>(*) <span class="fn">FILTER</span> (
    <span class="kw">WHERE</span> message->>
      <span class="str">'additional_kwargs'</span> = <span class="str">'Equipe'</span>
    <span class="kw">AND</span> created_at > <span class="fn">TO_TIMESTAMP</span>(
      (<span class="kw">SELECT</span> wait <span class="kw">FROM</span> dados_cliente
       <span class="kw">WHERE</span> <span class="str">"clientID"</span> = <span class="str">'{{ ClientID }}'</span>
      ) / <span class="num">1000.0</span>)
  ) <span class="kw">AS</span> msgs_equipe_apos_wait
<span class="kw">FROM</span> n8n_chat_histories
<span class="kw">WHERE</span> session_id = <span class="str">'{{ ClientID }}'</span></pre></div>
    <div class="cb"><div class="ch"><span class="cl sql">Cadastro â€” UPSERT</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">WITH</span> adapter <span class="kw">AS</span> (
  <span class="kw">SELECT</span>
    <span class="fn">NULLIF</span>(<span class="fn">TRIM</span>(<span class="str">'{{ ClientID }}'</span>), <span class="str">''</span>) <span class="kw">AS</span> cid,
    <span class="fn">NULLIF</span>(<span class="fn">TRIM</span>(<span class="str">'{{ telefone }}'</span>), <span class="str">''</span>) <span class="kw">AS</span> tel,
    <span class="fn">NULLIF</span>(<span class="fn">TRIM</span>(<span class="str">'{{ Nome }}'</span>), <span class="str">''</span>) <span class="kw">AS</span> nome
)
<span class="kw">INSERT INTO</span> dados_cliente (
  <span class="str">"clientID"</span>, telefone, nome,
  ia_ativa, status
) <span class="kw">SELECT</span>
  cid, tel, <span class="fn">COALESCE</span>(nome, <span class="str">'Cliente'</span>),
  <span class="kw">true</span>, <span class="str">'new'</span>
<span class="kw">FROM</span> adapter
<span class="kw">ON CONFLICT</span> (<span class="str">"clientID"</span>) <span class="kw">DO UPDATE SET</span>
  nome = <span class="kw">CASE WHEN</span> <span class="fn">NULLIF</span>(EXCLUDED.nome,<span class="str">''</span>)
    <span class="kw">IS NOT NULL THEN</span> EXCLUDED.nome
    <span class="kw">ELSE</span> dados_cliente.nome <span class="kw">END</span>
<span class="kw">RETURNING</span> *;</pre></div>
    <div class="cb"><div class="ch"><span class="cl sql">Mark â€” Follow-up</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">UPDATE</span> dados_cliente <span class="kw">SET</span>
  followup_count = <span class="fn">LEAST</span>(
    <span class="fn">COALESCE</span>(followup_count, <span class="num">0</span>) + <span class="num">1</span>, <span class="num">2</span>),
  ultimo_followup = <span class="fn">EXTRACT</span>(<span class="fn">EPOCH</span>
    <span class="kw">FROM NOW</span>()) * <span class="num">1000</span>
<span class="kw">WHERE</span> <span class="str">"clientID"</span> = <span class="str">'{{ ClientID }}'</span>
  <span class="kw">AND</span> followup_count < <span class="num">2</span>
<span class="kw">RETURNING</span> <span class="str">"clientID"</span>, followup_count;</pre></div>
    <div class="cb"><div class="ch"><span class="cl sql">Save History</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">INSERT INTO</span> n8n_chat_histories
  (session_id, message)
<span class="kw">VALUES</span> (
  <span class="str">'{{ ClientID }}'</span>,
  <span class="str">'{{ JSON.stringify({
    type: "human",
    content: mensagem,
    additional_kwargs:
      fromMe ? "Equipe" : "Cliente",
    response_metadata: {
      rota: rota,
      timestamp: wait
    }
  }) }}'</span>
);</pre></div>
  </div>
</div>

<!-- â•â•â• TAB: ROTAS â•â•â• -->
<div class="panel" id="rotas">
  <div class="stitle"><span class="icon">ðŸ—ºï¸</span> Tabela de Rotas Completa <span class="line"></span></div>
  <div style="display:grid;grid-template-columns:130px 1fr 1fr;gap:14px;padding:8px 18px;font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted)"><span>Rota</span><span>CondiÃ§Ã£o</span><span>AÃ§Ã£o</span></div>
  <div class="rr"><div><span class="rb ein">EQUIPE IN</span></div><div><div class="rl">Trigger</div><div class="rv"><code>fromMe=true AND fim=false</code></div></div><div><div class="rl">Resultado</div><div class="rv">ia=false, wait=now, msgs=0 â†’ <strong>PARA</strong></div></div></div>
  <div class="rr"><div><span class="rb eout">EQUIPE OUT</span></div><div><div class="rl">Trigger</div><div class="rv"><code>fromMe=true AND fim=true</code></div></div><div><div class="rl">Resultado</div><div class="rv">ia=true, wait=0 â†’ <strong>Briefing â†’ LLM</strong></div></div></div>
  <div class="rr"><div><span class="rb buf">BUFFER</span></div><div><div class="rl">Trigger</div><div class="rv"><code>!fromMe AND !ia AND msgs&lt;2</code></div></div><div><div class="rl">Resultado</div><div class="rv">msgs++ â†’ <strong>SilÃªncio</strong></div></div></div>
  <div class="rr"><div><span class="rb buf">BUFFER FULL</span></div><div><div class="rl">Trigger</div><div class="rv"><code>!fromMe AND !ia AND msgsâ‰¥2</code></div></div><div><div class="rl">Resultado</div><div class="rv">ia=true, msgs=0 â†’ <strong>Briefing â†’ LLM</strong></div></div></div>
  <div class="rr" style="border:1px solid rgba(239,68,68,.2)"><div><span class="rb abn">ðŸ”¥ ABANDONO</span></div><div><div class="rl">Trigger</div><div class="rv"><code>!ia AND msgsâ‰¥1 AND wait>0 AND Î”>2min</code></div></div><div><div class="rl">Resultado</div><div class="rv">ia=true, wait=0, msgs=0 â†’ <strong>Auto-resume</strong></div></div></div>
  <div class="rr"><div><span class="rb cad">CADASTRO</span></div><div><div class="rl">Trigger</div><div class="rv"><code>is_new=true</code></div></div><div><div class="rl">Resultado</div><div class="rv">UPSERT â†’ <strong>Briefing â†’ LLM</strong></div></div></div>
  <div class="rr"><div><span class="rb cli">CLIENTE</span></div><div><div class="rl">Trigger</div><div class="rv">Default Â· <code>ia_ativa=true Â· fromMe=false</code></div></div><div><div class="rl">Resultado</div><div class="rv">Fluxo normal â†’ <strong>Briefing â†’ LLM</strong></div></div></div>
</div>

<!-- â•â•â• TAB: CHECK FAIL â•â•â• -->
<div class="panel" id="checkfail">
  <div class="stitle"><span class="icon">ðŸ”¥</span> Check Fail & Abandono <span class="line"></span></div>
  <div class="cb"><div class="ch"><span class="cl txt">Fluxo Check Fail</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>EQUIPE_IN/OUT â†’ Save History â†’ Set Buffer â†’ <span class="kw">Timestamp</span> (1min wait)
    â†’ rotas(minor) Switch
        â”œâ”€ EQUIPE_IN/OUT â†’ <span class="fn">Check Fail SQL</span> â†’ Fail IF
        â”‚     â”œâ”€ <span class="str">True</span>  (â‰¤1 msg equipe) â†’ Merge Route â†’ <span class="kw">IA retoma</span>
        â”‚     â””â”€ <span class="num">False</span> (â‰¥2 msgs equipe) â†’ Kill (<span class="cmt">FIM</span>)
        â””â”€ BUFFER â†’ Buffer Update â†’ Compare â†’ Merge Route</pre></div>
  <div class="card-grid cols-2" style="margin-top:16px">
    <div class="gc c"><h3>LÃ³gica</h3><div class="sub">1. Espera 1 min apÃ³s Save History<br>2. Conta msgs da Equipe apÃ³s wait<br>3. â‰¤1 msg â†’ equipe abandonou â†’ IA retoma<br>4. â‰¥2 msgs â†’ conversa real â†’ Kill</div></div>
    <div class="gc y"><h3>Cron Backup</h3><div class="sub"><code>zera-wait-expirado</code> roda a cada 1 min<br>Se ia_ativa=false AND wait>0 AND delta>2min<br>â†’ SET wait=0 automaticamente<br>Garante recuperaÃ§Ã£o se n8n falhar</div></div>
  </div>
</div>

<!-- â•â•â• TAB: FOLLOW-UP â•â•â• -->
<div class="panel" id="followup">
  <div class="stitle"><span class="icon">ðŸ“¡</span> Follow-Up AutomÃ¡tico <span class="line"></span></div>
  <div class="stitle2">CondiÃ§Ãµes (todas verdadeiras)</div>
  <div class="cb"><div class="ch"><span class="cl sql">Push Follow Query</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>ia_ativa = <span class="kw">true</span>
<span class="kw">AND</span> followup_count < <span class="num">2</span>
<span class="kw">AND</span> off = <span class="kw">false</span>
<span class="kw">AND</span> (now_ms - ultimo_followup) > <span class="num">10800000</span>  <span class="cmt">-- 3h cooldown</span>
<span class="kw">AND</span> msgs_pendentes >= <span class="num">2</span>
<span class="kw">AND</span> (now_ms - wait) > <span class="num">300000</span>              <span class="cmt">-- 5min desde Ãºltima msg</span></pre></div>
  <div class="card-grid cols-3" style="margin-top:16px">
    <div class="gc v" style="padding:14px"><div class="sub">Cooldown</div><div class="val" style="font-size:1.3rem">3 horas</div></div>
    <div class="gc c" style="padding:14px"><div class="sub">MÃ¡x tentativas</div><div class="val" style="font-size:1.3rem">2</div></div>
    <div class="gc y" style="padding:14px"><div class="sub">Wait mÃ­nimo</div><div class="val" style="font-size:1.3rem">5 min</div></div>
  </div>
</div>

<!-- â•â•â• TAB: CRON â•â•â• -->
<div class="panel" id="cron">
  <div class="stitle"><span class="icon">â°</span> Cron Jobs (pg_cron) <span class="line"></span></div>
  <div class="tw"><table>
    <tr><th>jobid</th><th>Nome</th><th>Schedule</th><th>Status</th></tr>
    <tr><td>14</td><td><code>healing-check</code></td><td><span class="tag">* * * * *</span> (1min)</td><td><span class="tag g">âœ… Ativo</span></td></tr>
    <tr><td>15</td><td><code>zera-wait-expirado</code></td><td><span class="tag">* * * * *</span> (1min)</td><td><span class="tag g">âœ… Ativo</span></td></tr>
    <tr><td>9</td><td><code>limpeza_semanal</code></td><td><span class="tag">Dom 2h</span></td><td><span class="tag g">âœ… Ativo</span></td></tr>
    <tr><td><del>6</del></td><td><del>pre_follow_3min</del></td><td>â€”</td><td><span class="tag r">ðŸ—‘ï¸ Removido</span></td></tr>
    <tr><td><del>7</del></td><td><del>pre_follow_10min</del></td><td>â€”</td><td><span class="tag r">ðŸ—‘ï¸ Removido</span></td></tr>
  </table></div>
  <div class="cb" style="margin-top:16px"><div class="ch"><span class="cl sql">zera-wait-expirado</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre><span class="kw">UPDATE</span> dados_cliente <span class="kw">SET</span> wait = <span class="num">0</span>
<span class="kw">WHERE</span> ia_ativa = <span class="kw">false</span>
  <span class="kw">AND</span> wait > <span class="num">0</span>
  <span class="kw">AND</span> (<span class="fn">EXTRACT</span>(<span class="fn">EPOCH</span> <span class="kw">FROM NOW</span>()) * <span class="num">1000</span>)
      > (wait + <span class="num">120000</span>);</pre></div>
</div>

<!-- â•â•â• TAB: REDIS â•â•â• -->
<div class="panel" id="redis">
  <div class="stitle"><span class="icon">âš¡</span> Redis â€” Buffer AssÃ­ncrono <span class="line"></span></div>
  <div class="card" style="margin-bottom:16px">
    <p style="font-size:.9rem;margin-bottom:12px">Redis acumula mensagens durante o <strong style="color:var(--c2)">Wait de 6 segundos</strong>, consolidando mÃºltiplas mensagens rÃ¡pidas em uma Ãºnica resposta.</p>
  </div>
  <div class="cb"><div class="ch"><span class="cl txt">Redis Flow</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>Merge Route â†’ <span class="kw">Push</span> (Redis) â†’ <span class="fn">Wait 6s</span> â†’ <span class="kw">Get</span> (Redis) â†’ <span class="kw">Delete</span> (Redis)
    â†’ IF (dedup: Ãºltima msg = msg atual?)
        â”œâ”€ <span class="str">True</span>  â†’ Digitando (jÃ¡ processada)
        â””â”€ <span class="num">False</span> â†’ <span class="fn">Join</span> (junta msgs) â†’ To Briefing</pre></div>
</div>

<!-- â•â•â• TAB: OUTPUT â•â•â• -->
<div class="panel" id="output">
  <div class="stitle"><span class="icon">ðŸ“¤</span> Output & Envio <span class="line"></span></div>
  <div class="tw"><table>
    <tr><th>Output</th><th>CondiÃ§Ã£o</th><th>Destino</th></tr>
    <tr><td><span class="tag v">equipe</span></td><td><code>enviar_equipe && !enviar_cliente</code></td><td>Evolution API (canal equipe)</td></tr>
    <tr><td><span class="tag y">audio</span></td><td><code>gerar_audio = true</code></td><td>Eleven Labs â†’ Spliter</td></tr>
    <tr><td><span class="tag g">cliente</span></td><td><code>enviar_cliente = true</code></td><td>Spliter â†’ Loop â†’ Evolution send</td></tr>
  </table></div>
  <div class="cb" style="margin-top:16px"><div class="ch"><span class="cl txt">Loop de Envio</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>Spliter (divide parÃ¡grafos, mÃ¡x <span class="num">5</span>)
  â†’ Loop (SplitInBatches)
    â†’ <span class="fn">Wait 5min</span>
    -> <span class="kw">Send</span> texto (Evolution API)
    -> Retry em falha (max 3)</pre></div>
  <div class="card-grid cols-3" style="margin-top:16px">
    <div class="gc v" style="padding:14px"><div class="sub">Quebra de mensagem</div><div class="val" style="font-size:1.3rem">ate 5 blocos</div></div>
    <div class="gc c" style="padding:14px"><div class="sub">Delay entre envios</div><div class="val" style="font-size:1.3rem">500 ms</div></div>
    <div class="gc g" style="padding:14px"><div class="sub">Canal principal</div><div class="val" style="font-size:1.3rem">texto</div></div>
  </div>
</div>
<!-- TAB: GUARDRAILS -->
<div class="panel" id="guardrails">
  <div class="stitle"><span class="icon">[SEC]</span> Guardrails de Producao <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="card">
      <div class="stitle2" style="margin-top:0">Regras de Seguranca</div>
      <div class="ir ok"><span class="ii">OK</span><div><div class="it">LLM nao escreve no banco</div><div class="id">Toda alteracao de estado passa por SQL nodes auditaveis.</div></div></div>
      <div class="ir ok"><span class="ii">OK</span><div><div class="it">Router e funcao pura</div><div class="id">Sem I/O, sem side effects, somente decisao de rota.</div></div></div>
      <div class="ir warn"><span class="ii">WARN</span><div><div class="it">Mensagens com limite</div><div class="id">Max 500 chars e 4 linhas no selector antes de enviar.</div></div></div>
      <div class="ir err"><span class="ii">STOP</span><div><div class="it">Kill switch habilitado</div><div class="id">Falha critica ou conversa de equipe valida interrompe automacao.</div></div></div>
    </div>
    <div class="card">
      <div class="stitle2" style="margin-top:0">Checks Obrigatorios</div>
      <div class="pb">
        <div class="pl"><span>Adapter normaliza tipos</span><span class="tag g">OK</span></div>
        <div class="pt"><div class="pf" style="width:100%;background:linear-gradient(90deg,var(--g1),var(--g3))"></div></div>
      </div>
      <div class="pb">
        <div class="pl"><span>Router respeita 7 rotas</span><span class="tag g">OK</span></div>
        <div class="pt"><div class="pf" style="width:100%;background:linear-gradient(90deg,var(--c1),var(--c3))"></div></div>
      </div>
      <div class="pb">
        <div class="pl"><span>Abandono recupera em ate 2min</span><span class="tag y">MONITORAR</span></div>
        <div class="pt"><div class="pf" style="width:92%;background:linear-gradient(90deg,var(--y1),var(--y3))"></div></div>
      </div>
      <div class="pb">
        <div class="pl"><span>Fallback sem resposta vazia</span><span class="tag g">OK</span></div>
        <div class="pt"><div class="pf" style="width:100%;background:linear-gradient(90deg,var(--v1),var(--v3))"></div></div>
      </div>
    </div>
  </div>
</div>
<!-- TAB: WORKBOOK -->
<div class="panel" id="workbook">
  <div class="stitle"><span class="icon">[DOC]</span> Workbook Operacional <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="card">
      <div class="stitle2" style="margin-top:0">Checklist de Deploy</div>
      <div class="ir ok"><span class="ii">1.</span><div><div class="it">Variaveis de ambiente</div><div class="id">Verificar chaves Evolution, DB, Redis e LLM.</div></div></div>
      <div class="ir ok"><span class="ii">2.</span><div><div class="it">Cron jobs ativos</div><div class="id"><code>healing-check</code> e <code>zera-wait-expirado</code> a cada 1 minuto.</div></div></div>
      <div class="ir ok"><span class="ii">3.</span><div><div class="it">Workflow validado</div><div class="id">Executar teste de cliente novo, equipe in/out e abandono.</div></div></div>
      <div class="ir ok"><span class="ii">4.</span><div><div class="it">Observabilidade</div><div class="id">Garantir logs de rota, status e timestamp em todas as mensagens.</div></div></div>
    </div>
    <div class="card">
      <div class="stitle2" style="margin-top:0">Sequencia de Teste Manual</div>
      <div class="flow">
        <div class="fi">
          <div class="fl"><div class="fd" style="border-color:var(--v1);color:var(--v3)">1</div><div class="fc" style="background:var(--v1)"></div></div>
          <div class="ft"><h4>Cliente envia "oi"</h4><p>Esperado: rota CLIENTE, briefing e resposta da IA.</p></div>
        </div>
        <div class="fi">
          <div class="fl"><div class="fd" style="border-color:var(--y1);color:var(--y3)">2</div><div class="fc" style="background:var(--y1)"></div></div>
          <div class="ft"><h4>Equipe assume conversa</h4><p>Esperado: EQUIPE_IN, ia_ativa=false, wait=now.</p></div>
        </div>
        <div class="fi">
          <div class="fl"><div class="fd" style="border-color:var(--r1);color:var(--r3)">3</div><div class="fc" style="background:var(--r1)"></div></div>
          <div class="ft"><h4>Simular abandono por 2 min</h4><p>Esperado: auto-resume para CLIENTE com ia_ativa=true.</p></div>
        </div>
        <div class="fi">
          <div class="fl"><div class="fd" style="border-color:var(--g1);color:var(--g3)">4</div></div>
          <div class="ft"><h4>Cliente volta a responder</h4><p>Esperado: fluxo normal sem perda de contexto.</p></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- TAB: TROUBLESHOOT -->
<div class="panel" id="troubleshoot">
  <div class="stitle"><span class="icon">[FIX]</span> Troubleshooting Rapido <span class="line"></span></div>
  <div class="tw"><table>
    <tr><th>Sintoma</th><th>Causa provavel</th><th>Acao</th></tr>
    <tr><td>IA nao responde</td><td><code>ia_ativa=false</code> e wait preso</td><td>Rodar cron/manual para zerar wait e revisar EQUIPE_OUT.</td></tr>
    <tr><td>Mensagens duplicadas</td><td>Dedup Redis nao executou</td><td>Validar chave Redis por <code>clientID</code> e node Delete.</td></tr>
    <tr><td>Status invalido</td><td>LLM retornou campo fora de contrato</td><td>Selector aplica fallback para <code>new</code> e loga evento.</td></tr>
    <tr><td>Follow-up excessivo</td><td><code>followup_count</code> nao atualizado</td><td>Checar query Mark Follow-up e retorno SQL.</td></tr>
    <tr><td>Equipe sobrescrita por IA</td><td>Check Fail nao bloqueou</td><td>Revisar contagem de msgs apos wait e condicao do IF.</td></tr>
  </table></div>
  <div class="alert y" style="margin-top:16px">[WARN] Sempre validar o estado no banco antes de alterar nodes de decisao.</div>
</div>
<!-- TAB: ANTI-REGRESSAO -->
<div class="panel" id="antireg">
  <div class="stitle"><span class="icon">[QA]</span> Anti-Regressao <span class="line"></span></div>
  <div class="card-grid cols-2">
    <div class="card">
      <div class="stitle2" style="margin-top:0">Suite Minima (sempre rodar)</div>
      <div class="cb"><div class="ch"><span class="cl txt">Casos obrigatorios</span><div class="dots"><i class="r"></i><i class="y"></i><i class="g"></i></div></div>
<pre>1) Cliente novo -> Cadastro -> CLIENTE -> resposta IA
2) Equipe IN -> Check Fail true -> IA retoma
3) Equipe IN + 2 msgs equipe -> Kill
4) Buffer com 2 msgs -> BUFFER FULL -> CLIENTE
5) Follow-up maximo 2 tentativas</pre></div>
    </div>
    <div class="card">
      <div class="stitle2" style="margin-top:0">Regras de Merge</div>
      <div class="ir ok"><span class="ii">OK</span><div><div class="it">Nao remover invariantes</div><div class="id">Qualquer PR deve preservar as 6 invariantes do sistema.</div></div></div>
      <div class="ir ok"><span class="ii">OK</span><div><div class="it">Router com prioridade fixa</div><div class="id">Abandono sempre antes de outras condicoes.</div></div></div>
      <div class="ir warn"><span class="ii">WARN</span><div><div class="it">Limites de mensagem</div><div class="id">Nao aumentar sem revisar prompt, selector e envio.</div></div></div>
      <div class="ir ok"><span class="ii">OK</span><div><div class="it">Compatibilidade com cron</div><div class="id">Toda mudanca em wait deve manter recuperacao automatica.</div></div></div>
    </div>
  </div>
</div>
</div>
<footer class="footer">
  <strong>GENIUS v3.6</strong> - Workbook tecnico unificado para operacao, diagnostico e evolucao continua.
</footer>
<script>
(() => {
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const panels = Array.from(document.querySelectorAll('.panel'));
  function activate(tabId) {
    tabs.forEach((tab) => {
      tab.classList.toggle('active', tab.dataset.tab === tabId);
    });
    panels.forEach((panel) => {
      panel.classList.toggle('active', panel.id === tabId);
    });
  }
  tabs.forEach((tab) => {
    tab.addEventListener('click', () => activate(tab.dataset.tab));
  });
  const hash = window.location.hash.replace('#', '');
  if (hash && panels.some((p) => p.id === hash)) {
    activate(hash);
  }
  document.addEventListener('keydown', (event) => {
    if (event.key !== 'ArrowRight' && event.key !== 'ArrowLeft') return;
    const currentIndex = tabs.findIndex((tab) => tab.classList.contains('active'));
    if (currentIndex < 0) return;
    const nextIndex = event.key === 'ArrowRight'
      ? (currentIndex + 1) % tabs.length
      : (currentIndex - 1 + tabs.length) % tabs.length;
    const nextTab = tabs[nextIndex];
    activate(nextTab.dataset.tab);
    nextTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  });
})();
</script>
</body>
</html>

